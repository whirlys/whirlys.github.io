<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Elasticsearch 分布式特性 | 小旋锋</title>
  <meta name="keywords" content=" elasticsearch ">
  <meta name="description" content="Elasticsearch 分布式特性 | 小旋锋">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="以下源码分析使用的 Java 版本为 1.8   1. 概览ArrayList 是基于数组实现的，继承 AbstractList， 实现了 List、RandomAccess、Cloneable、Serializable 接口，支持随机访问。 java.util public class ArrayList&amp;lt;E&amp;gt; extends AbstractList&amp;lt;E&amp;gt;">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="ArrayList 源码分析">
<meta property="og:url" content="http://laijianfeng.org/2019/01/ArrayList-源码分析/index.html">
<meta property="og:site_name" content="小旋锋">
<meta property="og:description" content="以下源码分析使用的 Java 版本为 1.8   1. 概览ArrayList 是基于数组实现的，继承 AbstractList， 实现了 List、RandomAccess、Cloneable、Serializable 接口，支持随机访问。 java.util public class ArrayList&amp;lt;E&amp;gt; extends AbstractList&amp;lt;E&amp;gt;">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://image.laijianfeng.org/20180913_001328.png">
<meta property="og:updated_time" content="2019-01-09T12:22:21.858Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ArrayList 源码分析">
<meta name="twitter:description" content="以下源码分析使用的 Java 版本为 1.8   1. 概览ArrayList 是基于数组实现的，继承 AbstractList， 实现了 List、RandomAccess、Cloneable、Serializable 接口，支持随机访问。 java.util public class ArrayList&amp;lt;E&amp;gt; extends AbstractList&amp;lt;E&amp;gt;">
<meta name="twitter:image" content="http://image.laijianfeng.org/20180913_001328.png">


<link rel="icon" href="/img/favicon.jpg">

<link rel="stylesheet" href="/css/style.css">

<link rel="stylesheet" href="/css/hl_theme/darcula.css">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<link href="//cdn.bootcss.com/photoswipe/4.1.2/photoswipe.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/photoswipe/4.1.2/default-skin/default-skin.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="true">
</div>
<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>小旋锋</span>
</div>

<div class="icon">
    
    <a class="rss" title="rss" href="/atom.xml" target="_blank"></a>
    
    
    <a class="github" title="github" href="https://github.com/whirlys" target="_blank"></a>
    
    
    
    
    
    
    
    
    <a class="email" title="email" href="mailto:whirlys@163.com"></a>
    
</div>



<ul>
    <li class="all active">全部文章</li>
    
    <li data-rel="大数据"> 大数据 </li>
    
    <li data-rel="生活杂记"> 生活杂记 </li>
    
    <li data-rel="后端"> 后端 </li>
    
    <li data-rel="读书"> 读书 </li>
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    </div>
    <div><a  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="37">
<input type="hidden" id="yelog_site_word_count" value="114.6k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>
    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
            <li><a target="_blank" href="https://godbmw.com/">GODBMW</a></li>
            
            <li><a target="_blank" href="http://www.codesheep.cn/">CodeSheep 程序羊</a></li>
            
            <li><a target="_blank" href="http://www.hualong.me/">刘华龙的小窝</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="以 in: 开头进行全文搜索" autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
        <label for="tagswitch">Tags:</label>
        <input id="tagswitch" type="checkbox">
    </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">elasticsearch</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">Java编程</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">java</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">lucene</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">博客</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">设计模式</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">spark</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        <a  class="后端 "
           href="/2019/01/ArrayList-源码分析/"
           data-tag="Java编程"
           data-author="" >
            <span class="post-title" title="ArrayList 源码分析">ArrayList 源码分析</span>
            <span class="post-date" title="2019-01-09 20:21:09">2019/01/09</span>
        </a>
        
        <a  class="大数据 "
           href="/2019/01/Elasticsearch源码分析-单节点的启动和关闭/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="Elasticsearch源码分析 | 单节点的启动和关闭">Elasticsearch源码分析 | 单节点的启动和关闭</span>
            <span class="post-date" title="2019-01-08 01:58:56">2019/01/08</span>
        </a>
        
        <a  class="后端 "
           href="/2019/01/设计模式-单例模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 单例模式及典型应用">设计模式 | 单例模式及典型应用</span>
            <span class="post-date" title="2019-01-07 01:35:54">2019/01/07</span>
        </a>
        
        <a  class="后端 "
           href="/2018/12/Java-动态代理详解/"
           data-tag="Java编程"
           data-author="" >
            <span class="post-title" title="Java 动态代理详解">Java 动态代理详解</span>
            <span class="post-date" title="2018-12-21 01:46:11">2018/12/21</span>
        </a>
        
        <a  class="后端 "
           href="/2018/12/Java反射机制详解/"
           data-tag="Java编程"
           data-author="" >
            <span class="post-title" title="Java反射机制详解">Java反射机制详解</span>
            <span class="post-date" title="2018-12-19 02:08:32">2018/12/19</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/12/Spark-SQL-分析-Imooc-访问日志/"
           data-tag="spark"
           data-author="" >
            <span class="post-title" title="Spark SQL 分析 Nginx 访问日志">Spark SQL 分析 Nginx 访问日志</span>
            <span class="post-date" title="2018-12-16 19:45:35">2018/12/16</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-责任链模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 责任链模式及典型应用">设计模式 | 责任链模式及典型应用</span>
            <span class="post-date" title="2018-10-31 15:16:12">2018/10/31</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-中介者模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 中介者模式及典型应用">设计模式 | 中介者模式及典型应用</span>
            <span class="post-date" title="2018-10-26 00:45:30">2018/10/26</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-备忘录模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 备忘录模式及典型应用">设计模式 | 备忘录模式及典型应用</span>
            <span class="post-date" title="2018-10-25 00:42:24">2018/10/25</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-观察者模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 观察者模式及典型应用">设计模式 | 观察者模式及典型应用</span>
            <span class="post-date" title="2018-10-24 00:30:56">2018/10/24</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-策略模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 策略模式及典型应用">设计模式 | 策略模式及典型应用</span>
            <span class="post-date" title="2018-10-18 20:33:43">2018/10/18</span>
        </a>
        
        <a  class="生活杂记 "
           href="/2018/10/20181013-燃烧吧，破铜烂铁！/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="20181013-燃烧吧，破铜烂铁！">20181013-燃烧吧，破铜烂铁！</span>
            <span class="post-date" title="2018-10-13 22:01:20">2018/10/13</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-迭代器模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 迭代器模式及典型应用">设计模式 | 迭代器模式及典型应用</span>
            <span class="post-date" title="2018-10-11 23:04:40">2018/10/11</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-模板方法模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 模板方法模式及典型应用">设计模式 | 模板方法模式及典型应用</span>
            <span class="post-date" title="2018-10-11 00:22:11">2018/10/11</span>
        </a>
        
        <a  class="后端 "
           href="/2018/10/设计模式-组合模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 组合模式及典型应用">设计模式 | 组合模式及典型应用</span>
            <span class="post-date" title="2018-10-05 17:18:04">2018/10/05</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式-享元模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 享元模式及典型应用">设计模式 | 享元模式及典型应用</span>
            <span class="post-date" title="2018-09-25 01:15:00">2018/09/25</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式-适配器模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 适配器模式及典型应用">设计模式 | 适配器模式及典型应用</span>
            <span class="post-date" title="2018-09-20 01:00:54">2018/09/20</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式-装饰者模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 装饰者模式及典型应用">设计模式 | 装饰者模式及典型应用</span>
            <span class="post-date" title="2018-09-18 20:44:31">2018/09/18</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式-外观模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 外观模式及典型应用">设计模式 | 外观模式及典型应用</span>
            <span class="post-date" title="2018-09-16 20:29:56">2018/09/16</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式-原型模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 原型模式及典型应用">设计模式 | 原型模式及典型应用</span>
            <span class="post-date" title="2018-09-15 00:08:13">2018/09/15</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式-建造者模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 建造者模式及典型应用">设计模式 | 建造者模式及典型应用</span>
            <span class="post-date" title="2018-09-12 00:39:42">2018/09/12</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式之抽象工厂模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 抽象工厂模式及典型应用">设计模式 | 抽象工厂模式及典型应用</span>
            <span class="post-date" title="2018-09-10 23:51:05">2018/09/10</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式之工厂方法模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 工厂方法模式及典型应用">设计模式 | 工厂方法模式及典型应用</span>
            <span class="post-date" title="2018-09-09 17:20:14">2018/09/09</span>
        </a>
        
        <a  class="后端 "
           href="/2018/09/设计模式-简单工厂模式及典型应用/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="设计模式 | 简单工厂模式及典型应用">设计模式 | 简单工厂模式及典型应用</span>
            <span class="post-date" title="2018-09-07 23:13:45">2018/09/07</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/09/Elasticsearch-6-3-2-启动过程/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="Elasticsearch 6.3.2 启动过程">Elasticsearch 6.3.2 启动过程</span>
            <span class="post-date" title="2018-09-01 20:25:45">2018/09/01</span>
        </a>
        
        <a  class="后端 "
           href="/2018/08/Google-guava工具类的介绍和使用/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="Google guava工具类的介绍和使用">Google guava工具类的介绍和使用</span>
            <span class="post-date" title="2018-08-31 00:58:57">2018/08/31</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/Elasticsearch-中的-Guice/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="Elasticsearch 中的 Guice">Elasticsearch 中的 Guice</span>
            <span class="post-date" title="2018-08-31 00:39:17">2018/08/31</span>
        </a>
        
        <a  class="读书 "
           href="/2018/08/鼓舞人心/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="鼓舞人心">鼓舞人心</span>
            <span class="post-date" title="2018-08-27 19:51:31">2018/08/27</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/Elasticsearch-分布式特性/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="Elasticsearch 分布式特性">Elasticsearch 分布式特性</span>
            <span class="post-date" title="2018-08-25 18:29:15">2018/08/25</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/23个最有用的ES检索技巧-Java-API实现/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="23个最有用的ES检索技巧(Java API实现)">23个最有用的ES检索技巧(Java API实现)</span>
            <span class="post-date" title="2018-08-25 13:19:00">2018/08/25</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/教你编译调试Elasticsearch-6-3-2源码/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="教你编译调试Elasticsearch 6.3.2源码">教你编译调试Elasticsearch 6.3.2源码</span>
            <span class="post-date" title="2018-08-23 11:39:34">2018/08/23</span>
        </a>
        
        <a  class="生活杂记 "
           href="/2018/08/20180818音乐会/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="20180818音乐会">20180818音乐会</span>
            <span class="post-date" title="2018-08-18 22:44:24">2018/08/18</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/Lucene初体验/"
           data-tag="lucene"
           data-author="" >
            <span class="post-title" title="Lucene初体验">Lucene初体验</span>
            <span class="post-date" title="2018-08-18 16:23:02">2018/08/18</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/Elasticsearch-6-x-Mapping设置/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="Elasticsearch 6.x Mapping设置">Elasticsearch 6.x Mapping设置</span>
            <span class="post-date" title="2018-08-16 21:14:33">2018/08/16</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/倒排索引与分词/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="倒排索引与分词">倒排索引与分词</span>
            <span class="post-date" title="2018-08-15 23:50:57">2018/08/15</span>
        </a>
        
        <a  class="大数据 "
           href="/2018/08/ElasticSearch初体验/"
           data-tag="elasticsearch"
           data-author="" >
            <span class="post-title" title="ElasticSearch初体验">ElasticSearch初体验</span>
            <span class="post-date" title="2018-08-15 19:37:25">2018/08/15</span>
        </a>
        
        <a  class="后端 "
           href="/2018/05/使用hexo-github-pages搭建博客/"
           data-tag="博客"
           data-author="" >
            <span class="post-title" title="使用hexo+github pages搭建博客">使用hexo+github pages搭建博客</span>
            <span class="post-date" title="2018-05-23 11:35:46">2018/05/23</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-Elasticsearch-分布式特性" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Elasticsearch 分布式特性</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
            <a href="javascript:" data-rel="大数据">大数据</a>
            
        </span>
        
        
        <span class="tag">
            
            <a href="javascript:" class="color4">elasticsearch</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2018-08-25 18:32:23'>2018-08-25 18:29</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:3,491</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式介绍及cerebro"><span class="toc-text">分布式介绍及cerebro</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cerebro"><span class="toc-text">cerebro</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构建集群"><span class="toc-text">构建集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cluster-State-集群状态"><span class="toc-text">Cluster State 集群状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Master-Node-主节点"><span class="toc-text">Master Node 主节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Coordinating-Node"><span class="toc-text">Coordinating Node</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Data-Node-数据节点"><span class="toc-text">Data Node 数据节点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#副本与分片"><span class="toc-text">副本与分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#提高系统可用性"><span class="toc-text">提高系统可用性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#增大系统容量"><span class="toc-text">增大系统容量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分片的分布"><span class="toc-text">分片的分布</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cluster-Health-集群健康"><span class="toc-text">Cluster Health 集群健康</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Failover-故障转移"><span class="toc-text">Failover 故障转移</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文档分布式存储"><span class="toc-text">文档分布式存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#文档到分片的映射算法"><span class="toc-text">文档到分片的映射算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文档创建流程"><span class="toc-text">文档创建流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文档读取流程"><span class="toc-text">文档读取流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文档批量创建的流程"><span class="toc-text">文档批量创建的流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文档批量读取的流程"><span class="toc-text">文档批量读取的流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#脑裂问题"><span class="toc-text">脑裂问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#倒排索引的不可变更"><span class="toc-text">倒排索引的不可变更</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文档搜索实时性"><span class="toc-text">文档搜索实时性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#refresh"><span class="toc-text">refresh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#translog"><span class="toc-text">translog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flush"><span class="toc-text">flush</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#refresh-1"><span class="toc-text">refresh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除与更新文档"><span class="toc-text">删除与更新文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#整体视角"><span class="toc-text">整体视角</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Segment-Merging"><span class="toc-text">Segment Merging</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文的主要内容：</p>
<ul>
<li>分布式介绍及cerebro</li>
<li>构建集群</li>
<li>副本与分片</li>
<li>集群状态与故障转移</li>
<li>文档分布式存储</li>
<li>脑裂问题</li>
<li>shard详解</li>
</ul>
<h3 id="分布式介绍及cerebro"><a href="#分布式介绍及cerebro" class="headerlink" title="分布式介绍及cerebro"></a>分布式介绍及cerebro</h3><p>ES支持集群模式，是一个分布式系统，其好处主要有两个：</p>
<ul>
<li>增大系统容量，如内存、磁盘，使得ES集群可以支持PB级的数据</li>
<li>提高系统可用性，即使部分节点停止服务，整个集群依然可以正常服务</li>
</ul>
<p>ES集群由多个ES实例组成</p>
<ul>
<li>不同集群通过集群名称来区分，可通过cluster.name进行修改，名称默认为elasticsearch</li>
<li>每个ES实例本质上是一个JVM进程，且有自己的名字，通过node.name进行修改</li>
</ul>
<h4 id="cerebro"><a href="#cerebro" class="headerlink" title="cerebro"></a>cerebro</h4><p>cerebro 是一个ES Web管理工具，项目地址 <a href="https://github.com/lmenezes/cerebro" target="_blank" rel="noopener">https://github.com/lmenezes/cerebro</a> </p>
<p>其配置文件为 conf/application.conf，启动 cerebro ，默认监听的地址为 0.0.0.0:9000</p>
<pre><code>bin/cerebro
# 也可指定监听ip和端口号
bin/cerebro -Dhttp.port=1234 -Dhttp.address=127.0.0.1
</code></pre><p>访问 <a href="http://yourhost:9000" target="_blank" rel="noopener">http://yourhost:9000</a> ，填写要监控的 ES 地址：<a href="http://eshost:9200" target="_blank" rel="noopener">http://eshost:9200</a> 即可进入管理界面</p>
<p><img src="http://image.laijianfeng.org/20180825_150701.png" alt="cerebro管理界面"></p>
<p><img src="http://image.laijianfeng.org/20180825_151133.png" alt="cerebro 节点信息"></p>
<p><img src="http://image.laijianfeng.org/20180825_151323.png" alt="cerebro 集群配置"></p>
<p>在cerebro管理界面中我们可以看到 ES节点、索引、shard的分布、集群参数配置等多种信息</p>
<h3 id="构建集群"><a href="#构建集群" class="headerlink" title="构建集群"></a>构建集群</h3><p>如果只有一台机器，可以执行下面的命令，每次指定相同的集群名称，不同的节点名称和端口，即可在同一台机器上启动多个ES节点</p>
<pre><code>bin/elasticsearch -Ecluster.name=my_cluster -Enode.name=node1 -Ehttp.port=9200 -d
</code></pre><p>作者的是在 virtualbox 上安装Ubuntu虚拟机，在安装好开发环境，正常启动ES之后，采取复制虚拟机的做法，复制后需要修改虚拟机的UUID，做法可自行上网搜索。</p>
<p>作者复制了两个，准备构建一个拥有三个ES节点的集群。启动虚拟机后可以进行关闭防火墙，配置hosts以使相互之间能够通过主机名访问，配置ssh免密访问等操作</p>
<p>分别修改ES节点中的 <code>cluster.name</code> 为相同名称，<code>node.name</code> 为各自的主机名，<code>network.host</code> 为 <code>0.0.0.0</code>，<code>discovery.zen.ping.unicast.hosts</code> 列表中中加入各自的 <code>node.name</code></p>
<p>在ES主目录下执行命令启动ES</p>
<pre><code>bin/elasticsearch
</code></pre><p>查看日志可见集群搭建完毕</p>
<h4 id="Cluster-State-集群状态"><a href="#Cluster-State-集群状态" class="headerlink" title="Cluster State 集群状态"></a>Cluster State 集群状态</h4><p>与ES集群相关的数据称为cluster state，主要记录如下信息：</p>
<ul>
<li>节点信息，比如节点名称、连接地址等</li>
<li>索引信息，比如索引名称，配置等</li>
<li>其他。。</li>
</ul>
<h4 id="Master-Node-主节点"><a href="#Master-Node-主节点" class="headerlink" title="Master Node 主节点"></a>Master Node 主节点</h4><ul>
<li>可以修改cluster state的节点成为master节点，一个集群<strong>只能有一个</strong></li>
<li>cluster state存储在每个节点上，master维护最新版本并<strong>同步</strong>给其他节点</li>
<li>master节点是通过集群中所有节点<strong>选举产生</strong>的，可以<strong>被选举</strong>的节点成为master-eligible（候选）节点，相关配置如下：<code>node.master: true</code></li>
</ul>
<h4 id="Coordinating-Node"><a href="#Coordinating-Node" class="headerlink" title="Coordinating Node"></a>Coordinating Node</h4><ul>
<li><strong>处理请求</strong>的节点即为coordinating节点，该节点为所有节点的默认角色，不能取消</li>
<li>路由请求到正确的节点处理，比如创建索引的请求到master节点</li>
</ul>
<h4 id="Data-Node-数据节点"><a href="#Data-Node-数据节点" class="headerlink" title="Data Node 数据节点"></a>Data Node 数据节点</h4><ul>
<li><strong>存储数据</strong>的节点即为Data节点，默认节点都是data类型，相关配置如下：<code>node.data: true</code></li>
</ul>
<h3 id="副本与分片"><a href="#副本与分片" class="headerlink" title="副本与分片"></a>副本与分片</h3><h4 id="提高系统可用性"><a href="#提高系统可用性" class="headerlink" title="提高系统可用性"></a>提高系统可用性</h4><p>提高系统可用性可从两个方面考虑：服务可用性和数据可用性</p>
<p>服务可用性：</p>
<ul>
<li>2个节点的情况下，允许其中1个节点停止服务</li>
</ul>
<p>数据可用性</p>
<ul>
<li>引入副本（Replication）解决</li>
<li>每个节点上都有完备的数据</li>
</ul>
<h4 id="增大系统容量"><a href="#增大系统容量" class="headerlink" title="增大系统容量"></a>增大系统容量</h4><p>如何将数据分布于所有节点上？</p>
<ul>
<li>引入分片（shard）解决问题</li>
</ul>
<p>分片是ES支持PB级数据的基石</p>
<ul>
<li>分片存储了部分数据，可以分布于任意节点上</li>
<li>分片数在索引创建时指定且后续不允许再修改，默认为5个</li>
<li>分片有主分片和副本分片之分，以实现数据的高可用</li>
<li>副本分片的数据由主分片同步，可以有多个，从而提高读取的吞吐量</li>
</ul>
<h4 id="分片的分布"><a href="#分片的分布" class="headerlink" title="分片的分布"></a>分片的分布</h4><p>下图演示的是 3 个节点的集群中test_index的分片分布情况，创建时我们指定了3个分片和副本</p>
<pre><code>PUT test_index
{
  &quot;settings&quot;: {
    &quot;number_of_replicas&quot;: 1,
    &quot;number_of_shards&quot;: 3
  }
}
</code></pre><p><img src="http://image.laijianfeng.org/20180825_164121.png" alt="主副分片的分布"></p>
<p>大致是均匀分布，实验中如果由于磁盘空间不足导致有分片未分配，为了测试可以将集群设置 <code>cluster.routing.allocation.disk.threshold_enabled</code> 设置为 false</p>
<ul>
<li><strong>此时增加节点是否能提高索引的数据容量？</strong></li>
</ul>
<p>不能，因为已经设置了分片数为 3 ，shard的数量已经确定，新增的节点无法利用，</p>
<ul>
<li><strong>此时增加副本数能否提高索引的读取吞吐量？</strong></li>
</ul>
<p>不能，因为新增的副本分片也是分布在这 3 台节点上，利用了同样的资源（CPU，内存，IO等）。如果要增加吞吐量，同时还需要增加节点的数量</p>
<ul>
<li><strong>分片数的设定很重要，需要提前规划好</strong><ul>
<li>过小会导致后续无法通过增加节点实现水平扩容</li>
<li>过大会导致一个节点上分布过多分片，造成资源浪费，同时会影响查询性能</li>
<li>shard的数量的确定：一般建议一个shard的数据量不要超过 <code>30G</code>，shard数量最小为 2</li>
</ul>
</li>
</ul>
<h3 id="Cluster-Health-集群健康"><a href="#Cluster-Health-集群健康" class="headerlink" title="Cluster Health 集群健康"></a>Cluster Health 集群健康</h3><p>通过如下API可以查看集群健康状况，状态status包括以下三种：</p>
<ul>
<li>green 健康状态，指所有主副分片都正常分配</li>
<li>yellow 指所有主分片都正常分配，但有副本分片未正常分配</li>
<li>red 有主分片未分配</li>
</ul>
<pre><code>GET _cluster/health

# 结果
{
  &quot;cluster_name&quot;: &quot;elasticsearch&quot;,
  &quot;status&quot;: &quot;yellow&quot;,
  &quot;timed_out&quot;: false,
  &quot;number_of_nodes&quot;: 1,
  &quot;number_of_data_nodes&quot;: 1,
  &quot;active_primary_shards&quot;: 115,
  &quot;active_shards&quot;: 115,
  &quot;relocating_shards&quot;: 0,
  &quot;initializing_shards&quot;: 0,
  &quot;unassigned_shards&quot;: 111,
  &quot;delayed_unassigned_shards&quot;: 0,
  &quot;number_of_pending_tasks&quot;: 0,
  &quot;number_of_in_flight_fetch&quot;: 0,
  &quot;task_max_waiting_in_queue_millis&quot;: 0,
  &quot;active_shards_percent_as_number&quot;: 50.88495575221239
}
</code></pre><h4 id="Failover-故障转移"><a href="#Failover-故障转移" class="headerlink" title="Failover 故障转移"></a>Failover 故障转移</h4><p>集群由 3 个节点组成，名称分别为 master，Hadoop2，Hadoop3， 其中 master 为主节点，集群状态status为 green</p>
<p><img src="http://image.laijianfeng.org/20180825_174406.png" alt="集群状态green"></p>
<p><strong>如果此时 master 所在机器宕机导致服务终止，此时集群如何处理？</strong></p>
<p>Hadoop2 和 Hadoop3 发现 master 无法响应一段时间后会发起 master 主节点选举，比如这里选择 Hadoop2 为 master 节点。由于此时主分片 P0 和 P2 下线，集群状态变为 Red</p>
<p><img src="http://image.laijianfeng.org/20180825_174933.png" alt="节点master宕机"></p>
<p>node2 发现主分片 P0 和 P2 未分配，将 R0 和 R2 提升为主分片，此时由于所有主分片都正常分配，集群状态变为 yellow</p>
<p><img src="http://image.laijianfeng.org/20180825_175028.png" alt="image"></p>
<p>Hadoop2 为 P0 和 P2 生成新的副本，集群状态变为绿色</p>
<p><img src="http://image.laijianfeng.org/20180825_175235.png" alt="image"></p>
<p>最后看看 Hadoop2 打印的日志</p>
<p><img src="http://image.laijianfeng.org/20180825_175517.png" alt="image"></p>
<h3 id="文档分布式存储"><a href="#文档分布式存储" class="headerlink" title="文档分布式存储"></a>文档分布式存储</h3><p>文档最终会存储在分片上。文档选择分片需要文档到分片的<strong>映射算法</strong>，目的是使得文档均匀分布在所有分片上，以充分利用资源。</p>
<p>算法：</p>
<ul>
<li>随机选择或者round-robin算法？不可取，因为需要维护文档到分片的映射关系，成本巨大</li>
<li><strong>根据文档值实时计算对应的分片</strong></li>
</ul>
<h4 id="文档到分片的映射算法"><a href="#文档到分片的映射算法" class="headerlink" title="文档到分片的映射算法"></a>文档到分片的映射算法</h4><p>ES通过如下的公式计算文档对应的分片</p>
<ul>
<li><code>shard = hash(routing) % number_of_primary_shards</code></li>
<li>hash算法保证可以将数据均匀地分散在分片中</li>
<li>routing是一个关键参数，默认是文档id，也可以自行指定</li>
<li>number_of_primary_shards是主分片数</li>
</ul>
<p>该算法与主分片数相关，这也是分片数一旦确定后便不能更改的原因</p>
<h4 id="文档创建流程"><a href="#文档创建流程" class="headerlink" title="文档创建流程"></a>文档创建流程</h4><ol>
<li>Client向node3发起创建文档的请求</li>
<li>node3通过routing计算该文档应该存储在shard1上，查询cluster state后确认主分片P1在node2上，然后转发创建文档的请求到node2</li>
<li>P1 接收并执行创建文档请求后，将同样的请求发送到副本分片R1</li>
<li>R1接收并执行创建文档请求后，通知P1成功的结果</li>
<li>P1接收副本分片结果后，通知node3创建成功</li>
<li>node3返回结果到Client</li>
</ol>
<p><img src="http://image.laijianfeng.org/20180825_181026.png" alt="文档创建流程"></p>
<h4 id="文档读取流程"><a href="#文档读取流程" class="headerlink" title="文档读取流程"></a>文档读取流程</h4><ol>
<li>Client向node3发起获取文档1的请求</li>
<li>node3通过routing计算该文档在shard1上，查询cluster state后获取shard1的主副分片列表，然后以轮询的机制获取一个shard，比如这里是R1，然后转发读取文档的请求到node1</li>
<li>R1接收并执行读取文档请求后，将结果返回node3</li>
<li>node3返回结果给client</li>
</ol>
<p><img src="http://image.laijianfeng.org/20180825_181511.png" alt="文档读取流程"></p>
<h4 id="文档批量创建的流程"><a href="#文档批量创建的流程" class="headerlink" title="文档批量创建的流程"></a>文档批量创建的流程</h4><ol>
<li>client向node3发起批量创建文档的请求（bulk）</li>
<li>node3通过routing计算所有文档对应的shard，然后按照主shard分配对应执行的操作，同时发送请求到涉及的主shard，比如这里3个主shard都需要参与</li>
<li>主shard接收并执行请求后，将同样的请求同步到对应的副本shard</li>
<li>副本shard执行结果后返回到主shard，主shard再返回node3</li>
<li>node3整合结果后返回client</li>
</ol>
<p><img src="http://image.laijianfeng.org/20180825_181725.png" alt="文档批量创建的流程 bulk"></p>
<h4 id="文档批量读取的流程"><a href="#文档批量读取的流程" class="headerlink" title="文档批量读取的流程"></a>文档批量读取的流程</h4><ol>
<li>client向node3发起批量获取所有文档的请求（mget）</li>
<li>node3通过routing计算所有文档对应的shard，然后通过轮询的机制获取要参与shard，按照shard投建mget请求，通过发送请求到涉及shard，比如这里有2个shard需要参与</li>
<li>R1，R2返回文档结果</li>
<li>node3返回结果给client</li>
</ol>
<p><img src="http://image.laijianfeng.org/20180825_182023.png" alt="文档批量读取的流程 mget"></p>
<h3 id="脑裂问题"><a href="#脑裂问题" class="headerlink" title="脑裂问题"></a>脑裂问题</h3><p>脑裂问题，英文为split-brain，是分布式系统中的经典网络问题，如下图所示：</p>
<p>3个节点组成的集群，突然node1的网络和其他两个节点中断<br><img src="http://image.laijianfeng.org/20180807_1234.png" alt="image"></p>
<p>node2与node3会重新选举master，比如node2成为了新的master，此时会更新cluster state</p>
<p>node1自己组成集群后，也更新cluster state</p>
<p>同一个集群有两个master，而且维护不同的cluster state，网络恢复后无法选择正确的master</p>
<p><img src="http://image.laijianfeng.org/20180807_1235.png" alt="image"></p>
<p><strong>解决方案</strong>为仅在可选举master-eligible节点数大于等于quorum时才可以进行master选举</p>
<ul>
<li><code>quorum = master-eligible节点数/2 + 1</code>，例如3个master-eligible节点时，quorum 为2 </li>
<li>设定 <code>discovery.zen.minimun_master_nodes</code> 为 <code>quorum</code> 即可避免脑裂问题</li>
</ul>
<p><img src="http://image.laijianfeng.org/20180807_1236.png" alt="image"></p>
<h3 id="倒排索引的不可变更"><a href="#倒排索引的不可变更" class="headerlink" title="倒排索引的不可变更"></a>倒排索引的不可变更</h3><p>倒排索引一旦生成，不能更改<br>其好处如下：</p>
<ul>
<li>不用考虑并发写文件的问题，杜绝了锁机制带来的性能问题</li>
<li>由于文件不再更改，可以充分利用文件系统缓存，只需载入一次，只要内存足够，对该文件的读取都会从内存读取，性能高</li>
<li>利于生成缓存数据</li>
<li>利于对文件进行压缩存储，节省磁盘和内存存储空间</li>
</ul>
<p>坏处为需要写入新文档时，必须重新构建倒排索引文件，然后替换老文件后，新文档才能被检索，导致文档实时性差</p>
<h3 id="文档搜索实时性"><a href="#文档搜索实时性" class="headerlink" title="文档搜索实时性"></a>文档搜索实时性</h3><p><strong>解决方案</strong>是新文档直接生成新的倒排索引文件，查询的时候同时查询所有的倒排文件，然后做结果的汇总计算即可</p>
<p>Lucene便是采用了这种方案，它构建的单个倒排索引称为segment，合在一起称为index，与ES中的Index概念不同，ES中的一个shard对应一个Lucene Index</p>
<p>Lucene会有一个专门的文件来记录所有的segment信息，称为commit point<br><img src="http://image.laijianfeng.org/20180807_1237.png" alt="image"></p>
<h4 id="refresh"><a href="#refresh" class="headerlink" title="refresh"></a>refresh</h4><p>segment写入磁盘的过程依然很耗时，可以借助文件系统缓存的特性，现将segment在缓存中创建并开放查询来进一步提升实时性，该过程在ES中被称为<code>refresh</code></p>
<p>在refresh之前文档会先存储在一个buffer中，refresh时将buffer中的所有文档清空并生成segment</p>
<p>ES默认每1秒执行一次refresh，因此文档的实时性被提高到1秒，这也是ES被称为 近实时(Near Real Time)的原因<br><img src="http://image.laijianfeng.org/20180807_1238.png" alt="image"></p>
<h4 id="translog"><a href="#translog" class="headerlink" title="translog"></a>translog</h4><p>如果在内存中的segment还没有写入磁盘前发生了宕机，那么其中的文档就无法恢复了，如何解决这个问题呢？</p>
<ul>
<li>ES引入translog机制，写入文档到buffer时，同时将该操作写入translog</li>
<li>translog文件会即时写入磁盘(fsync)，6.x默认每个请求都会落盘</li>
</ul>
<p><img src="http://image.laijianfeng.org/20180807_1345.png" alt="image"></p>
<h4 id="flush"><a href="#flush" class="headerlink" title="flush"></a>flush</h4><p>flush负责将内存中的segment写入磁盘，主要做成如下的工作：</p>
<ul>
<li>将translog写入磁盘</li>
<li>将index buffer清空，其中的文档生成一个新的segment，相当于一个refresh操作</li>
<li>更新commit point并写入磁盘</li>
<li>执行fsync操作，将内存中的segment写入磁盘</li>
<li>删除旧的translog文件</li>
</ul>
<p><img src="http://image.laijianfeng.org/20180807_1239.png" alt="image"></p>
<p>flush发生的时机主要有如下几种情况：</p>
<ul>
<li>间隔时间达到时，默认是30分钟，5.x之前可以通过<code>index.translog.flush_threshold_period</code>修改，之后无法修改</li>
<li>translog占满时，其大小可以通过<code>index.translog.flush_threshold_size</code>控制，默认是512mb，每个index有自己的translog</li>
</ul>
<h4 id="refresh-1"><a href="#refresh-1" class="headerlink" title="refresh"></a>refresh</h4><p>refresh发生的时机主要有如下几种情况：</p>
<ul>
<li>间隔时间达到时，通过<code>index.settings.refresh_interval</code>来设定，默认是1秒</li>
<li><code>index.buffer</code>占满时，其大小通过<code>indices.memory.index_buffer_size</code>设置，默认为JVM heap的10%，所有shard共享</li>
<li>flush发生时也会发生refresh</li>
</ul>
<h4 id="删除与更新文档"><a href="#删除与更新文档" class="headerlink" title="删除与更新文档"></a>删除与更新文档</h4><p>segment一旦生成就不能更改，那么如果你要删除文档该如何操作？</p>
<ul>
<li>Lucene专门维护一个<code>.del</code>文件，记录所有已经删除的文档，注意<code>.del</code>上记录的是文档在Lucene内部的id</li>
<li>在查询结果返回前会过滤掉<code>.del</code>中所有的文档</li>
</ul>
<p>要更新文档如何进行呢？</p>
<ul>
<li>首先删除文档，然后再创建新文档</li>
</ul>
<h4 id="整体视角"><a href="#整体视角" class="headerlink" title="整体视角"></a>整体视角</h4><p>ES Index与Lucene Index的术语对照如下所示：<br><img src="http://image.laijianfeng.org/20180807_1346.png" alt="image"></p>
<h4 id="Segment-Merging"><a href="#Segment-Merging" class="headerlink" title="Segment Merging"></a>Segment Merging</h4><p>随着segment的增多，由于一次查询的segment数增多，查询速度会变慢<br>ES会定时在后台进行segment merge的操作，减少segment的数量<br>通过force_merge api可以手动强制做segment merge的操作</p>
<hr>
<p>打开微信扫一扫，关注【小旋锋】微信公众号，及时接收博文推送</p>
<p><img src="http://image.laijianfeng.org/%E5%B0%8F%E6%97%8B%E9%94%8B%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7_%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg" alt="小旋锋的微信公众号"></p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 whirlys@163.com </span>
    </div>
</article>


<p>
    <a href="javascript:void(0)" class="dashang" onclick="dashangToggle()">赏</a>
</p>


<div class="article_copyright">
    <p><span>文章标题:</span>Elasticsearch 分布式特性</p>
    <p><span>文章字数:</span><span class="post-count">3,491</span></p>
    <p><span>本文作者:</span><a href="javascript:void(0)" title="小旋锋">小旋锋</a></p>
    <p><span>发布时间:</span>2018-08-25, 18:29:15</p>
    <p><span>最后更新:</span>2018-08-25, 18:32:23</p>
    <span>原始链接:</span><a class="post-url" href="/2018/08/Elasticsearch-分布式特性/" title="Elasticsearch 分布式特性">http://laijianfeng.org/2018/08/Elasticsearch-分布式特性/</a>
    <p>
        <span>版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>


    <div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var gitment = new Gitment({
        id: 'Elasticsearch 分布式特性', // 可选。默认为 location.href
        owner: 'whirlys',
        repo: 'whirlys.github.io',
        oauth: {
            client_id: 'f1bd5294d498cdda9693',
            client_secret: '959bbaf23dae12023b1b9ee3e63e882a099ca65a',
        },
        perPage : 3
    })
    gitment.render('comments')
</script>



    </div>
    <div class="copyright">
        <p class="footer-entry">© 2018-2019, 小旋锋. All rights reserved.</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" href="javascript:void(0)"></a>
    </div>
</div>
<div class="acParent"></div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.png" class="alipay" title="扫码支持">
            <img src="/img/weixin.png" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>

</body>
<script src="//cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>

<script src="//cdn.bootcss.com/photoswipe/4.1.2/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.2/photoswipe-ui-default.min.js"></script>

<script src="/js/script.js"></script>
<script>
    var img_resize = 'photoSwipe';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#elasticsearch','#Java编程','#java','#lucene','#博客','#设计模式','#spark',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        

        // PhotoSwipe
        $('article').each(function(i){
            $(this).find('img').each(function(){
                if ($(this).closest('figure').hasClass('article-gallery-img')) {
                    return;
                }
                var alt = this.alt;
                $(this)
                    .wrap('<figure class="article-gallery-img" itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject"></figure>')
                    .wrap('<a href="' + this.src + '" title="' + alt + '"></a>');
                $(this).after('<div class="img_alt"><span>' + (alt || '') + '</span></div>');
            });
        });

        var pswpElement = document.querySelectorAll('.pswp')[0];
        if (pswpElement) {
            var gallerySelector = '.article-gallery, article';

            var initPhotoSwipeFromDOM = function(gallerySelector) {

                // parse slide data (url, title, size ...) from DOM elements
                // (children of gallerySelector)
                var parseThumbnailElements = function(el) {
                    var thumbElements = $(el).find('figure.article-gallery-img').toArray(),
                        numNodes = thumbElements.length,
                        items = [],
                        figureEl,
                        linkEl,
                        size,
                        imgEl,
                        item;

                    for (var i = 0; i < numNodes; i++) {

                        figureEl = thumbElements[i]; // <figure> element

                        // include only element nodes
                        if (figureEl.nodeType !== 1) {
                            continue;
                        }

                        linkEl = figureEl.children[0]; // <a> element
                        imgEl = linkEl.children[0]; // <img>

                        size = linkEl.getAttribute('data-size');
                        size = size && size.split('x');

                        // create slide object
                        item = {
                            src: linkEl.getAttribute('href'),
                            w: size && parseInt(size[0], 10) || imgEl.width,
                            h: size && parseInt(size[1], 10) || imgEl.height
                        };

                        if (figureEl.children.length > 1) {
                            // <figcaption> content
                            item.title = figureEl.children[1].innerHTML;
                        }

                        if (linkEl.children.length > 0) {
                            // <img> thumbnail element, retrieving thumbnail url
                            item.msrc = linkEl.children[0].getAttribute('src');
                        }

                        item.el = figureEl; // save link to element for getThumbBoundsFn
                        items.push(item);
                    }

                    return items;
                };

                // find nearest parent element
                var closest = function closest(el, fn) {
                    return el && (fn(el) ? el : closest(el.parentNode, fn));
                };

                // triggers when user clicks on thumbnail
                var onThumbnailsClick = function(e) {
                    e = e || window.event;

                    var eTarget = e.target || e.srcElement;

                    // find root element of slide
                    var clickedListItem = closest(eTarget, function(el) {
                        return (el.tagName && el.tagName.toUpperCase() === 'FIGURE');
                    });

                    if (!clickedListItem) {
                        return;
                    }

                    if (e.preventDefault) {
                        e.preventDefault();
                    } else {
                        e.returnValue = false;
                    }

                    // find index of clicked item by looping through all child nodes
                    // alternatively, you may define index via data- attribute
                    var clickedGallery = $(clickedListItem).closest(gallerySelector)[0],
                        childNodes = $(clickedGallery).find('figure.article-gallery-img').toArray(),
                        numChildNodes = childNodes.length,
                        nodeIndex = 0,
                        index;

                    for (var i = 0; i < numChildNodes; i++) {
                        if (childNodes[i].nodeType !== 1) {
                            continue;
                        }

                        if (childNodes[i] === clickedListItem) {
                            index = nodeIndex;
                            break;
                        }
                        nodeIndex++;
                    }



                    if (index >= 0) {
                        // open PhotoSwipe if valid index found
                        openPhotoSwipe(index, clickedGallery);
                    }
                    return false;
                };

                // parse picture index and gallery index from URL (#&pid=1&gid=2)
                var photoswipeParseHash = function() {
                    var hash = window.location.hash.substring(1),
                        params = {};

                    if (hash.length < 5) {
                        return params;
                    }

                    var vars = hash.split('&');
                    for (var i = 0; i < vars.length; i++) {
                        if (!vars[i]) {
                            continue;
                        }
                        var pair = vars[i].split('=');
                        if (pair.length < 2) {
                            continue;
                        }
                        params[pair[0]] = pair[1];
                    }

                    if (params.gid) {
                        params.gid = parseInt(params.gid, 10);
                    }

                    return params;
                };

                var openPhotoSwipe = function(index, galleryElement, disableAnimation, fromURL) {
                    var pswpElement = document.querySelectorAll('.pswp')[0],
                        gallery,
                        options,
                        items;

                    items = parseThumbnailElements(galleryElement);

                    // define options (if needed)
                    options = {

                        // define gallery index (for URL)
                        galleryUID: galleryElement.getAttribute('data-pswp-uid'),

                        getThumbBoundsFn: function(index) {
                            // See Options -> getThumbBoundsFn section of documentation for more info
                            var thumbnail = items[index].el.getElementsByTagName('img')[0], // find thumbnail
                                pageYScroll = window.pageYOffset || document.documentElement.scrollTop,
                                rect = thumbnail.getBoundingClientRect();

                            return {
                                x: rect.left,
                                y: rect.top + pageYScroll,
                                w: rect.width
                            };
                        }
                    };

                    // PhotoSwipe opened from URL
                    if (fromURL) {
                        if (options.galleryPIDs) {
                            // parse real index when custom PIDs are used
                            // http://photoswipe.com/documentation/faq.html#custom-pid-in-url
                            for (var j = 0; j < items.length; j++) {
                                if (items[j].pid == index) {
                                    options.index = j;
                                    break;
                                }
                            }
                        } else {
                            // in URL indexes start from 1
                            options.index = parseInt(index, 10) - 1;
                        }
                    } else {
                        options.index = parseInt(index, 10);
                    }

                    // exit if index not found
                    if (isNaN(options.index)) {
                        return;
                    }

                    if (disableAnimation) {
                        options.showAnimationDuration = 0;
                    }

                    // Pass data to PhotoSwipe and initialize it
                    gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);

                    gallery.listen('imageLoadComplete', function(index, item) {
                        var linkEl = item.el.children[0];
                        var img = item.container.children[0];
                        if (!linkEl.getAttribute('data-size')) {
                            linkEl.setAttribute('data-size', img.naturalWidth + 'x' + img.naturalHeight);
                            item.w = img.naturalWidth;
                            item.h = img.naturalHeight;
                            gallery.invalidateCurrItems();
                            gallery.updateSize(true);
                        }
                    });

                    gallery.init();
                };

                // loop through all gallery elements and bind events
                var galleryElements = document.querySelectorAll(gallerySelector);

                for (var i = 0, l = galleryElements.length; i < l; i++) {
                    galleryElements[i].setAttribute('data-pswp-uid', i + 1);
                    galleryElements[i].onclick = onThumbnailsClick;
                }

                // Parse URL and open gallery if it contains #&pid=3&gid=1
                var hashData = photoswipeParseHash();
                if (hashData.pid && hashData.gid) {
                    openPhotoSwipe(hashData.pid, galleryElements[hashData.gid - 1], true, true);
                }
            };

            // execute above function
            initPhotoSwipeFromDOM(gallerySelector);
        }
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /*引用块样式*/
    
    .post .pjax article blockquote {
        padding: 10px 20px;
        background-color: white;
        border: none;
        border-left: 4px solid #42b983;
        border-right: 4px solid #42b983;
        border-radius: 10px;
    }
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.1;
        background: url("http://image.laijianfeng.org/v2-cdcf5d00f2e9106f1fd0a70a18cbdf15_r1.jpg");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    
</style>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element, as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. -->
        <!-- don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>





</html>
